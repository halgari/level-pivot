name: CI

on:
  push:
    branches: [main]
    tags:
      - 'v*'
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            name: linux-x64
            triplet: x64-linux
            npm_platform: linux-x64
            lib_ext: so
          # TODO: Re-add other platforms later
          # - os: ubuntu-24.04-arm
          #   name: linux-arm64
          #   triplet: arm64-linux
          #   npm_platform: linux-arm64
          #   lib_ext: so
          # - os: macos-14
          #   name: darwin-arm64
          #   triplet: arm64-osx
          #   npm_platform: darwin-arm64
          #   lib_ext: so
          # - os: macos-13
          #   name: darwin-x64
          #   triplet: x64-osx
          #   npm_platform: darwin-x64
          #   lib_ext: so
          # - os: windows-latest
          #   name: windows-x64
          #   triplet: x64-windows
          #   npm_platform: windows-x64
          #   lib_ext: dll

    runs-on: ${{ matrix.os }}
    name: Build (${{ matrix.name }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: cc73782a88db48af17f8bfb8328d4cab3d4c246f

      - name: Install PostgreSQL
        run: |
          sudo apt-get update
          sudo apt-get install -y curl ca-certificates
          sudo install -d /usr/share/postgresql-common/pgdg
          sudo curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc
          sudo sh -c 'echo "deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
          sudo apt-get update
          sudo apt-get install -y postgresql-18 postgresql-server-dev-18

      - name: Configure CMake
        run: cmake --preset release

      - name: Build
        run: cmake --build build/release --config Release

      - name: Run Tests
        run: ctest --test-dir build/release --build-config Release --output-on-failure

      - name: Prepare artifacts
        run: |
          mkdir -p artifacts/level-pivot-${{ matrix.name }}
          cp build/release/level_pivot.${{ matrix.lib_ext }} artifacts/level-pivot-${{ matrix.name }}/
          cp sql/level_pivot--1.0.sql artifacts/level-pivot-${{ matrix.name }}/
          cp sql/level_pivot.control artifacts/level-pivot-${{ matrix.name }}/
          cp README.md artifacts/level-pivot-${{ matrix.name }}/
          cp LICENSE artifacts/level-pivot-${{ matrix.name }}/
          cd artifacts && tar -czvf level-pivot-${{ matrix.name }}.tar.gz level-pivot-${{ matrix.name }}

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: level-pivot-${{ matrix.name }}
          path: artifacts/*.tar.gz

      - name: Upload binary for NPM
        uses: actions/upload-artifact@v4
        with:
          name: npm-binary-${{ matrix.npm_platform }}
          path: build/release/level_pivot.${{ matrix.lib_ext }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: level-pivot-*
          merge-multiple: true

      - name: List artifacts
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*.tar.gz
            artifacts/*.zip
          generate_release_notes: true

  npm-publish:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Download all NPM binaries
        uses: actions/download-artifact@v4
        with:
          path: npm-binaries
          pattern: npm-binary-*

      - name: List downloaded binaries
        run: find npm-binaries -type f

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create platform package
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          PKG_DIR="npm/packages/level-pivot-linux-x64"
          BINARY_DIR="npm-binaries/npm-binary-linux-x64"

          echo "Creating package for linux-x64..."

          # Create package directory structure
          mkdir -p "${PKG_DIR}/binaries"
          mkdir -p "${PKG_DIR}/sql"

          # Copy binary
          cp "${BINARY_DIR}/level_pivot.so" "${PKG_DIR}/binaries/"

          # Copy SQL files
          cp sql/level_pivot.control "${PKG_DIR}/sql/"
          cp sql/level_pivot--1.0.sql "${PKG_DIR}/sql/"

          # Create package.json
          cat > "${PKG_DIR}/package.json" << EOF
          {
            "name": "@halgari/level-pivot-linux-x64",
            "version": "${VERSION}",
            "description": "linux-x64 binaries for @halgari/level-pivot",
            "main": "index.js",
            "scripts": {
              "build": "echo 'No build needed for binary package'",
              "test": "echo 'No tests for binary package'"
            },
            "files": [
              "index.js",
              "binaries",
              "sql"
            ],
            "os": ["linux"],
            "cpu": ["x64"],
            "keywords": ["leveldb", "postgresql", "level-pivot", "binary"],
            "author": "halgari",
            "license": "AGPL-3.0-only",
            "repository": {
              "type": "git",
              "url": "https://github.com/halgari/level-pivot.git",
              "directory": "npm/packages/level-pivot-linux-x64"
            }
          }
          EOF

          # Create index.js
          cat > "${PKG_DIR}/index.js" << 'EOF'
          const path = require('path');

          module.exports = {
            libraryPath: path.join(__dirname, 'binaries', 'level_pivot.so'),
            sqlPath: path.join(__dirname, 'sql'),
          };
          EOF

          echo "Created package for linux-x64"

      - name: Update main package version
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          cd npm/packages/level-pivot

          # Update version and optionalDependencies in package.json
          jq --arg v "$VERSION" '
            .version = $v |
            .optionalDependencies["@halgari/level-pivot-linux-x64"] = $v
          ' package.json > package.json.tmp
          mv package.json.tmp package.json

          cat package.json

      - name: Install dependencies and build
        run: |
          cd npm
          npm install
          npm run build

      - name: Publish platform package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd npm/packages/level-pivot-linux-x64
          echo "Publishing @halgari/level-pivot-linux-x64..."
          npm publish --access public --provenance

      - name: Publish main package
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd npm/packages/level-pivot
          npm publish --access public --provenance
